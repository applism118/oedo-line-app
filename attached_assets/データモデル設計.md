# 山手線ウォーキングプランナー データモデル設計

## 概要

このアプリケーションでは、以下のデータモデルを使用しています。主にフロントエンドのみで動作するアプリケーションのため、データモデルはTypeScriptのインターフェースとZodスキーマで定義され、ローカルストレージに保存されます。将来的な拡張のためのバックエンドデータベースモデルも概要として記載しています。

## フロントエンドデータモデル

### 駅情報モデル (Station)

```typescript
interface Station {
  name: string;       // 駅名
  nextDistance: number; // 次の駅までの距離（km）
}
```

- 説明：山手線の各駅の情報と、時計回りに次の駅までの距離を保持するモデル
- 使用箇所：`client/src/lib/stations.ts`で定義され、駅データの管理とルート計算に使用

### 歩行速度モデル (WalkingSpeed)

```typescript
interface WalkingSpeed {
  name: string;     // 速度識別子（slow, normal, fast）
  speedKmh: number; // 時速（km/h）
  label: string;    // 表示名（ゆっくり、普通、速い）
}
```

- 説明：利用可能な歩行速度のオプションを定義するモデル
- 使用箇所：`client/src/lib/stations.ts`で定義され、ルート計算と速度選択UIに使用

### 方向タイプ (Direction)

```typescript
type Direction = "clockwise" | "counterclockwise";
```

- 説明：進行方向を表す型（時計回りまたは反時計回り）
- 使用箇所：ルート計算と方向選択UIで使用

### ルート駅情報モデル (RouteStation)

```typescript
interface RouteStation {
  name: string;           // 駅名
  arrivalTime: Date;      // 到着時刻
  departureTime?: Date;   // 出発時刻（任意、休憩駅の場合に設定）
  isRestStation?: boolean; // 休憩駅かどうか
}
```

- 説明：経路計算結果の各駅情報を表すモデル（内部使用）
- 使用箇所：`calculateRoute`関数の戻り値として使用され、タイムライン表示などに活用

### ルートプランモデル (RoutePlan)

```typescript
const routePlanSchema = z.object({
  id: z.string(),                     // プランID（UUID）
  createdAt: z.date(),                // 作成日時
  fromStation: z.string(),            // 出発駅
  toStation: z.string(),              // 到着駅
  direction: z.enum(["clockwise", "counterclockwise"]), // 進行方向
  walkingSpeed: z.string(),           // 歩行速度ID
  startTime: z.date(),                // 出発時刻
  restMinutes: z.number(),            // 休憩時間（分）
  stations: z.array(z.object({        // ルート上の駅リスト
    name: z.string(),                 // 駅名
    arrivalTime: z.date(),            // 到着時刻
    departureTime: z.date().optional(), // 出発時刻（オプション）
    isRestStation: z.boolean().optional() // 休憩駅フラグ（オプション）
  })),
  totalDistance: z.number()           // 総距離（km）
});

type RoutePlan = z.infer<typeof routePlanSchema>;
```

- 説明：ユーザーが保存するルートプランの完全なデータモデル
- 使用箇所：`client/src/lib/storage.ts`で定義され、LocalStorageへの保存・取得に使用

## データ永続化

### ローカルストレージスキーマ

```
Key: 'yamanote-route-plans'
Value: JSON文字列（RoutePlan[]型の配列）
```

- 説明：ブラウザのローカルストレージに保存されるデータ形式
- シリアライズ：`JSON.stringify`でシリアライズ、日付型は文字列として保存され、取得時に`Date`オブジェクトに変換
- バリデーション：`zod`スキーマを使用して保存・取得時にデータの整合性を検証

## 主要関数とデータ操作

### ルート計算

```typescript
calculateRoute(
  fromStation: string,
  toStation: string,
  speedKmh: number,
  startTime: Date,
  direction: Direction = "clockwise",
  restMinutes: number = 30
): { 
  stations: Array<RouteStation>,
  totalDistance: number 
}
```

- 説明：指定した出発駅から到着駅までのルートを計算し、各駅の到着時刻、休憩情報、総距離を算出
- ロジック：
  - 駅間の距離と歩行速度から所要時間を計算
  - 5駅ごとに休憩駅を設定（出発駅と到着駅を除く）
  - 休憩駅では指定された休憩時間（分）を加算
  - 総距離を累積計算

### ルートプラン保存・取得

```typescript
// 保存されているプランを全て取得
getStoredPlans(): RoutePlan[]

// 新しいプランを保存
storePlan(plan: Omit<RoutePlan, 'id' | 'createdAt'>): RoutePlan

// プランを削除
deletePlan(planId: string): void

// 全てのプランを削除
deleteAllPlans(): void
```

- 説明：ローカルストレージを使用したプランのCRUD操作
- データ変換：
  - 保存時：日付をJSON化（文字列に変換）
  - 取得時：文字列を`Date`オブジェクトに変換
  - バリデーション：`zod`スキーマを使用して型の整合性を確保

## 将来的な拡張のためのバックエンドデータモデル（概念設計）

### ユーザーテーブル (users)

```typescript
export const users = pgTable("users", {
  id: serial("id").primaryKey(),
  email: text("email").notNull().unique(),
  name: text("name"),
  password: text("password").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull()
});
```

- 説明：将来的なユーザー登録・認証機能のためのユーザーテーブル
- リレーション：ユーザーは複数のルートプランを持つことができる（1対多）

### ルートプランテーブル（概念設計・未実装）

```typescript
// 概念設計（実際には実装されていない）
export const routePlans = pgTable("route_plans", {
  id: uuid("id").defaultRandom().primaryKey(),
  userId: integer("user_id").references(() => users.id),
  name: text("name").notNull(),
  fromStation: text("from_station").notNull(),
  toStation: text("to_station").notNull(),
  direction: text("direction").notNull(),
  walkingSpeed: text("walking_speed").notNull(),
  startTime: timestamp("start_time").notNull(),
  restMinutes: integer("rest_minutes").notNull(),
  totalDistance: numeric("total_distance").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull()
});
```

- 説明：ルートプランをデータベースに保存するための概念設計
- リレーション：各プランはユーザーに属し、複数の駅情報を持つ

## データフロー

1. ユーザーが駅と設定（速度、方向など）を選択
2. `calculateRoute`関数が呼び出され、ルート情報が計算
3. 計算結果がUIに表示される
4. ユーザーが「プランを保存」ボタンをクリック
5. `storePlan`関数がルート情報をZodでバリデーション
6. バリデーション済みデータがLocalStorageにJSON形式で保存
7. 保存済みプラン一覧表示時には`getStoredPlans`関数でデータを取得し、日付を適切に変換